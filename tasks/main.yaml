---
- name: check joined file
  ansible.builtin.stat:
    path: /root/joined
  register: stat_result

- name: set joined fact
  ansible.builtin.set_fact:
    kube_joined: true
  when: stat_result.stat.exists

- name: add apt key
  ansible.builtin.apt_key: 
    url: '{{ kube_apt_key_url }}'

- name: install kubeadm apt repository
  ansible.builtin.apt_repository: 
    repo: '{{ kube_apt_repository }}'

- name: check if kube_version is set
  ansible.builtin.fail:
    msg: kube_version not set
  when: kube_version is not defined

- name: install kubeadm kubectl kubelet and update apt cache 
  ansible.builtin.apt:
    update_cache: yes
    pkg:
      - kubeadm={{ kube_version }}
      - kubectl={{ kube_version }}
      - kubelet={{ kube_version }}

- name: hold kubeadm kubectl kubelet
  ansible.builtin.dpkg_selections:
    name: '{{ item }}'
    selection: hold
  loop:
    - kubeadm
    - kubectl
    - kubelet

  # if the first master node has not joined the cluster
  # this indicates that we have a fresh cluster
- ansible.builtin.include: init-control-plane.yaml
  when:
    - inventory_hostname == groups.kube_master[0]
    - kube_joined is not defined

- ansible.builtin.include: generate-join-tokens.yaml
- ansible.builtin.include: generate-cert-key.yaml

- name: write KUBELET_EXTRA_ARGS
  ansible.builtin.lineinfile:
    path: '/etc/systemd/system/kubelet.service.d/10-kubeadm.conf'
    line: "{{ 'Environment=\"KUBELET_EXTRA_ARGS=' + kube_kubelet_extra_args + '\"' }}"
    regexp: '^Environment="KUBELET_EXTRA_ARGS='
    state: present
  register: config

- name: restart kubelet
  ansible.builtin.systemd:
    state: restarted
    daemon_reload: true
    name: kubelet
  when: config is changed

- ansible.builtin.include: join-control-plane.yaml
  when: 
    - inventory_hostname in groups.kube_master
    - kube_joined is not defined

- ansible.builtin.include: join-worker-node.yaml
  when: 
    - inventory_hostname in groups.kube_worker
    - kube_joined is not defined

- name: create provisioned file
  ansible.builtin.shell: 'echo "true" > /root/joined'
  when: kube_joined is not defined

- name: check if config changed
  template:
    src: cilium-{{ kube_cilium_version }}.yaml.j2
    dest: /root/cilium.yaml
  when: inventory_hostname == groups.kube_master[0]
  register: cni
  check_mode: yes

- name: install cni
  ansible.builtin.shell: kubectl apply -f /root/cilium.yaml
  when: inventory_hostname == groups.kube_master[0] # TODO: only when cluster is new
